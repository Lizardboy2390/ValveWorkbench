#include "comparedialog.h"
#include "ui_comparedialog.h"
#include <QMessageBox>
#include <QString>

CompareDialog::CompareDialog(QWidget *parent) :
    QDialog(parent),
    ui(new Ui::CompareDialog)
{
    ui->setupUi(this);
    
    // Connect the close button
    connect(ui->pushButton, &QPushButton::clicked, this, &CompareDialog::accept);
    
    // Connect text changed signals for input fields
    connect(ui->grid, &QLineEdit::editingFinished, this, &CompareDialog::updateCalculations);
    connect(ui->anode, &QLineEdit::editingFinished, this, &CompareDialog::updateCalculations);
    connect(ui->gridP, &QLineEdit::editingFinished, this, &CompareDialog::updateCalculations);
    connect(ui->anodeP, &QLineEdit::editingFinished, this, &CompareDialog::updateCalculations);
    connect(ui->screen, &QLineEdit::editingFinished, this, &CompareDialog::updateCalculations);
}

CompareDialog::~CompareDialog()
{
    delete ui;
}

void CompareDialog::setModel(Model *model)
{
    if (!model) {
        QMessageBox::warning(this, "Error", "No model provided for comparison");
        return;
    }
    
    // Store the model as a member variable for later use
    m_model = model;
    
    // Get the device type (triode or pentode based on model type)
    int deviceType = (m_model->getType() == SIMPLE_TRIODE || 
                     m_model->getType() == KOREN_TRIODE || 
                     m_model->getType() == COHEN_HELIE_TRIODE) ? TRIODE : PENTODE;
    
    // For triode models
    if (deviceType == TRIODE) {
        // Show triode section, hide pentode section
        ui->triodeGroup->setVisible(true);
        ui->pentodeGroup->setVisible(false);
        
        // Set default test conditions
        ui->anode->setText("250");
        ui->grid->setText("-8");
        
        // Calculate and display the anode current
        double anodeVoltage = ui->anode->text().toDouble();
        double gridVoltage = ui->grid->text().toDouble();
        double ia = model->triodeAnodeCurrent(anodeVoltage, gridVoltage);
        ui->modIa->setText(QString::number(ia, 'f', 2));
        
        // Calculate mu, gm, ra from the model
        // We'll calculate these by using small changes in voltage
        double delta = 1.0; // 1V change for calculations
        
        // Calculate mu (amplification factor)
        double ia1 = model->triodeAnodeCurrent(anodeVoltage, gridVoltage);
        double ia2 = model->triodeAnodeCurrent(anodeVoltage, gridVoltage - delta);
        double vg_effect = (ia2 - ia1) / delta;
        
        double ia3 = model->triodeAnodeCurrent(anodeVoltage + delta, gridVoltage);
        double va_effect = (ia3 - ia1) / delta;
        
        double mu = va_effect != 0 ? vg_effect / va_effect : 0;
        double gm = vg_effect * 1000; // Convert to mA/V
        double ra = va_effect != 0 ? 1.0 / va_effect : 0;
        
        // Display the parameters
        ui->modMu->setText(QString::number(mu, 'f', 2));
        ui->modGm->setText(QString::number(gm, 'f', 2));
        ui->modRa->setText(QString::number(ra, 'f', 0));
        
        // Enable triode fields, disable pentode fields
        ui->triodeGroup->setEnabled(true);
        ui->pentodeGroup->setEnabled(false);
        
        // Calculate anode current at specified operating point
        updateCalculations();
    }
    // For pentode models
    else if (deviceType == PENTODE) {
        // Calculate pentode parameters
        // We'll calculate these by using small changes in voltage like we did for triodes
        double anodeVoltage = ui->anodeP->text().toDouble();
        double screenVoltage = ui->screen->text().toDouble();
        double gridVoltage = ui->gridP->text().toDouble();
        
        // Calculate gm and ra using voltage perturbations
        double delta = 1.0; // 1V change for calculations
        
        // Calculate gm (transconductance)
        double ia1 = model->anodeCurrent(anodeVoltage, screenVoltage, gridVoltage);
        double ia2 = model->anodeCurrent(anodeVoltage, screenVoltage, gridVoltage - delta);
        double gm = (ia2 - ia1) / delta;
        
        // Calculate ra (plate resistance)
        double ia3 = model->anodeCurrent(anodeVoltage + delta, screenVoltage, gridVoltage);
        double ra = delta / (ia3 - ia1);
        
        // Format the values with appropriate units
        // Clear triode section values since we're showing pentode
        ui->modelMu->setText("");  // Pentodes don't have mu in the same way
        ui->modelGm->setText("");
        ui->modelRa->setText("");
        ui->modelIa->setText("");
        
        // Use correct UI element names for pentode parameters
        ui->pentodeModelGm->setText(QString::number(gm * 1000.0, 'f', 1) + " mA/V");
        ui->pentodeModelRa->setText(QString::number(ra / 1000.0, 'f', 1) + " kΩ");
        
        // Enable pentode fields, disable triode fields
        ui->triodeGroup->setEnabled(false);
        ui->pentodeGroup->setEnabled(true);
        
        // Calculate anode current at specified operating point
        updateCalculations();
    }
}

// Set reference values for triodes
void CompareDialog::setReferenceValues(double mu, double gm, double ra)
{
    // Format the values with appropriate units
    ui->refMu->setText(QString::number(mu, 'f', 1));
    ui->refGm->setText(QString::number(gm * 1000.0, 'f', 1) + " mA/V");
    ui->refRa->setText(QString::number(ra / 1000.0, 'f', 1) + " kΩ");
    
    // Clear pentode reference values
    ui->pentodeRefIa->setText("");
    ui->pentodeRefGm->setText("");
    ui->pentodeRefRa->setText("");
}

// Set reference values for pentodes
void CompareDialog::setReferenceValues(double gm, double ra)
{
    // Clear triode reference values
    ui->refMu->setText("");
    ui->refGm->setText("");
    ui->refRa->setText("");
    ui->refIa->setText("");
    
    // Format the values with appropriate units
    ui->refGmP->setText(QString::number(gm * 1000.0, 'f', 1) + " mA/V");
    ui->refRaP->setText(QString::number(ra / 1000.0, 'f', 1) + " kΩ");
}

// Set reference currents for triodes
void CompareDialog::setReferenceCurrents(double ia)
{
    ui->refIa->setText(QString::number(ia * 1000.0, 'f', 1) + " mA");
}

// Set reference currents for pentodes
void CompareDialog::setReferenceCurrents(double ia, double screenCurrent)
{
    // Store reference currents for comparison
    // Note: screenCurrent is only used for pentodes
    Q_UNUSED(screenCurrent); // Suppress unused parameter warning
    
    ui->pentodeRefIa->setText(QString::number(ia * 1000.0, 'f', 1) + " mA");
    // Note: Screen current isn't displayed in the current UI design
}

// Update calculations when input values change
void CompareDialog::updateCalculations()
{
    if (!m_model) {
        return;
    }
    
    // Get the device type (triode or pentode based on model type)
    int deviceType = (m_model->getType() == SIMPLE_TRIODE || 
                     m_model->getType() == KOREN_TRIODE || 
                     m_model->getType() == COHEN_HELIE_TRIODE) ? TRIODE : PENTODE;
    
    // For triode models
    if (deviceType == TRIODE) {
        // Get input values
        bool gridOk = false;
        bool anodeOk = false;
        double gridVoltage = ui->grid->text().toDouble(&gridOk);
        double anodeVoltage = ui->anode->text().toDouble(&anodeOk);
        
        if (gridOk && anodeOk && gridVoltage < 0 && anodeVoltage > 0) {
            double ia = m_model->triodeAnodeCurrent(anodeVoltage, gridVoltage);
            ui->modIa->setText(QString::number(ia, 'f', 2));
            
            // Calculate mu, gm, ra from the model
            double delta = 1.0; // 1V change for calculations
            
            // Calculate mu (amplification factor)
            double ia1 = m_model->triodeAnodeCurrent(anodeVoltage, gridVoltage);
            double ia2 = m_model->triodeAnodeCurrent(anodeVoltage, gridVoltage - delta);
            double vg_effect = (ia2 - ia1) / delta;
            
            double ia3 = m_model->triodeAnodeCurrent(anodeVoltage + delta, gridVoltage);
            double va_effect = (ia3 - ia1) / delta;
            
            double mu = va_effect != 0 ? vg_effect / va_effect : 0;
            double gm = vg_effect * 1000; // Convert to mA/V
            double ra = va_effect != 0 ? 1.0 / va_effect : 0;
            
            // Display the parameters
            ui->modMu->setText(QString::number(mu, 'f', 2));
            ui->modGm->setText(QString::number(gm, 'f', 2));
            ui->modRa->setText(QString::number(ra, 'f', 0));
        } else {
            ui->modIa->setText("N/A");
            ui->modMu->setText("N/A");
            ui->modGm->setText("N/A");
            ui->modRa->setText("N/A");
        }
    }
    // For pentode models
    else if (deviceType == PENTODE) {
        // Get input values
        bool gridOk = false;
        bool anodeOk = false;
        bool screenOk = false;
        double gridVoltage = ui->gridP->text().toDouble(&gridOk);
        double anodeVoltage = ui->anodeP->text().toDouble(&anodeOk);
        double screenVoltage = ui->screen->text().toDouble(&screenOk);
        
        if (gridOk && anodeOk && screenOk && gridVoltage < 0 && anodeVoltage > 0 && screenVoltage > 0) {
            double ia = m_model->anodeCurrent(anodeVoltage, gridVoltage, screenVoltage);
            double is = m_model->screenCurrent(anodeVoltage, gridVoltage, screenVoltage);
            
            ui->pentodeModelIa->setText(QString::number(ia, 'f', 2));
            ui->pentodeModelIs->setText(QString::number(is, 'f', 2));
            
            // Calculate gm, ra from the model
            double delta = 1.0; // 1V change for calculations
            
            double ia1 = m_model->anodeCurrent(anodeVoltage, gridVoltage, screenVoltage);
            double ia2 = m_model->anodeCurrent(anodeVoltage, gridVoltage - delta, screenVoltage);
            double vg_effect = (ia2 - ia1) / delta;
            
            double ia3 = m_model->anodeCurrent(anodeVoltage + delta, gridVoltage, screenVoltage);
            double va_effect = (ia3 - ia1) / delta;
            
            double gm = vg_effect * 1000; // Convert to mA/V
            double ra = va_effect != 0 ? 1.0 / va_effect : 0;
            
            // Display the parameters
            ui->pentodeModelGm->setText(QString::number(gm, 'f', 2));
            ui->pentodeModelRa->setText(QString::number(ra, 'f', 0));
        } else {
            ui->pentodeModelIa->setText("N/A");
            ui->pentodeModelIs->setText("N/A");
            ui->pentodeModelGm->setText("N/A");
            ui->pentodeModelRa->setText("N/A");
        }
    }
}
